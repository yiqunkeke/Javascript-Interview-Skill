### 回调
* 回调是js语言中最基础的异步模式。
* 回调函数是javascript异步的主力军，并且它们不辱使命地完成了自己的任务。

### continuation
* 定义： 回调函数包裹或者说封装了程序的延续（continuation）
```
    // A
    ajax("..", function(..){
        // C
    });
    // B
```
* // A 和 // B 表示程序的前半部分（也就是现在的部分），而 // C 标识了程序的后半部分（也就是将来的部分）。

* 前半部分立刻执行，然后是一段时间不确定的停顿。在未来的某个时刻，如果ajax调用完成，程序就会从停下的位置继续执行后半部分。

### 回调缺点：
* 由于大脑工作方式与代码执行方式会出现分歧，将导致代码**难维护**、**难理解**、**难追踪**、**难调试**。

### 顺序的大脑
* 实际上，在任何特定的时刻，我们只能思考一件事情。
* 大脑好比js引擎。可以看作类似于单线程运行的事件循环队列。
* 代码通过回调表达异步的方式**并不能**很好地映射到同步的大脑计划行为。
* 人的思考方式是一步一步的，但是从同步转换到异步之后，可用的工具（回调）却不是按照一步一步的方式来表达的。

* 这就是为什么精确编写和追踪使用回调的异步js代码如此之难： 因为这不是我们大脑进行计划的运作方式。

### 地狱
* 对程序员来说，“他人的代码即地狱”。
* “不理解自己的代码才是地狱”。
* 回调就是主要元凶之一。

### 嵌套回调与链式回调
* 嵌套回调----又叫回调地狱(callback hell)或者毁灭金字塔（得名于嵌套缩进产生的横向三角形状）。
    * 理解其中的异步流非常**不自然**，也不容易。
    * 要找出正确的运行顺序，**需要费脑筋**才能想清楚。
    * 不能自然而然追踪到代码的执行顺序。

* 链式回调----
    * 代码脆弱性、复杂性，以至于无法维护和更新。

* 故顺序阻塞式的大脑计划行为，无法很好地映射到面向回调的异步代码。    

* 回调方式最主要的缺陷：对于它们在代码中表达异步的方式，我们的大脑需要努力才能同步得上。

### 控制反转------（回调最大的问题）
* // A 和 // B 受js主程序的直接控制
* // C 受第三方控制。

* 定义：控制反转就是把自己的程序一部分的执行控制交给某个第三方。
* 缺陷：存在信任问题
    * 比如“5个回调的故事”------出于某种原因把你的回调调用了5次而不是1次。
    * 虽然可以使用 latch处理对回调的多个并发调用。
    ```
        var tracked = false;
        analytics.trackPurchase(purchaseData, function() {
            if(!tracked) {
                tracked = true;
                chargeCreditCard();
                displayThankyouPage();
            }
        })
    ```
    * 再比如：
        * 一次也不调用回调
        * 调用过早
        * 调用过晚
        * 调用次数太多或太少
        * 没有把所需的参数成功传给你的回调
        * ......

    * 原则：信任但要核实

### 挽救回调
* 分离回调----Promise采用
```
    function success(data) {
        console.log(data)
    }
    function failure(err) {
        console.log(err)
    }
    ajax("http://some.url.1", success, failure)
```
* “error-first”风格回调----"Node风格"-----Node采用 
```
    function response(err, data) {
        if(err) {
            console.log(err)
        } else {
            console.log(data)
        }
    }
    ajax("http://some.url.1", response)
```   

* 缺陷：代码重复、项目变的笨重

### 总结：
* 回调可以实现所有你想要的功能，但是你需要努力才行。这些努力通常比你追踪这样的代码能够或者应该付出的要多的多。


### 回调的两个缺陷
* 缺乏顺序性
* 缺乏可信任性